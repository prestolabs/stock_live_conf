{
  "basic_data": [
    "TRADE_HIGH",
    "TRADE_PQ",
    "BOOK_VALID_COUNT",
    "TRADE_SELL_QTY_INFERRED",
    "TRADE_SELL_COUNT_INFERRED",
    "TRADE_BUY_PQ_INFERRED",
    "TRADE_BUY_COUNT_INFERRED",
    "TRADE_SELL_PQ_INFERRED",
    "TRADE_BUY_QTY_INFERRED",
    "TRADE_CLOSE",
    "TRADE_LOW",
    "MID_PRICE_CLOSE",
    "TRADE_QTY",
    "TRADE_COUNT",
    "SPREAD_CLOSE",
    "TRADE_OPEN",
    "HHMM_TAIWAN",
    "ASK_0_PRICE",
    "ASK_0_QTY",
    "BID_0_PRICE",
    "BID_0_QTY",
    "MOVE_BPS_SUM"
  ],
  "expression": [
    "interval_1day = 265",
//    "MARKET_START_INDEX = prev_5days_interval_length",
    "MARKET_START_INDEX = 1325",
    // "universe = And(TOP2000, Eq(day_trading_indicator_taiwan, 1))",
    "universe = TOP2000",
    "MOVE_BPS_SUM",
    "TRADE_CLOSE",
    "TRADE_QTY",
    "TRADE_PQ",
    "TRADE_BUY_PQ_INFERRED",
    "TRADE_BUY_COUNT_INFERRED",
    "TRADE_SELL_PQ_INFERRED",
    "TRADE_SELL_COUNT_INFERRED",
    "TRADE_BUY_QTY_INFERRED",
    "TRADE_SELL_QTY_INFERRED",
    "ADJ_FACTOR = adj_factor",
    "nshares_day",
    "prev_adj_factor",
    "prev_open_day",
    "prev_high_day",
    "prev_low_day",
    "prev_close_day",
    "prev_5days_max_volatility",
    "prev_5days_max_atr",
    "prev_rotation_rank_top2000",
    "turnover_ma5",
    "prev_5days_ret_rank_top2000",
    "prev_5days_intra_volatility",
    "prev2_close_2_prev_close",
    "prev_open_2_prev_close",
    "SPREAD_CLOSE",
    "prev_5days_ovn_volatility",
    "prev_turnover_rank_top2000",
    "log_prev_rotation",
    "exchange = Add(Multiply(twse, 2), tpex)",
    "HHMM = HHMM_TAIWAN",
    "HHMMSS = hhmmss",
    "hhmm = HHMM_TAIWAN",
    "ASK_PQ = Multiply(ASK_0_PRICE, ASK_0_QTY)",
    "BID_PQ = Multiply(BID_0_PRICE, BID_0_QTY)",
    "ASK_QTY = ASK_0_QTY",
    "BID_QTY = BID_0_QTY",
    "DAY_FIRST_HHMMSS = 90159",
    "DAY_FIRST_INTERVAL = Lt(HHMMSS, DAY_FIRST_HHMMSS)",
    "EXIST_TRADE = Gt(TRADE_COUNT, 0)",
    "EXIST_VALID_BOOK = Gt(BOOK_VALID_COUNT, 0)",
    "VALID = universe",
    "SELL_VALID = EXIST_VALID_BOOK",
    "CLOSE_PRICE = Fillforward(Multiply(MID_PRICE_CLOSE, adj_factor), interval_1day)",
    "DAY_HIGH_PRICE = TsMax(Multiply(TRADE_HIGH, adj_factor), interval_1day, DAY_FIRST_INTERVAL)",
    "DAY_LOW_PRICE = TsMin(Multiply(TRADE_LOW, adj_factor), interval_1day, DAY_FIRST_INTERVAL)",
    "DAY_OPEN_PRICE = Fillforward(Multiply(TRADE_OPEN, adj_factor), interval_1day, DAY_FIRST_INTERVAL)",
    "Return2(w1, w2) = Subtract(Divide(Delay(CLOSE_PRICE, w1), Delay(CLOSE_PRICE, w2)), 1)",
    "SeasonalityReturn(w1, w2, w3) = TsGapMean(NanToZero(Return2(w1, w2)), w3, w2)",
    "SeasonalityReturn2(w1, w2, w3) = TsGapMean(Subtract(Multiply(2, NanToZero(Return2(w1, w2))), NanToZero(Return2(0, w2))), w3, w2)",
    "DiffRatio(x, y) = Divide(Subtract(x, y), Add(x, y))",
    "TsMean(x, w) = Divide(TsSum(x, w), TsSum(IsFinite(x), w))",
    "CsMean(x) = Divide(CsSum(x, universe), CsSum(IsFinite(x), universe))",
    "Neut(x) = Subtract(x, CsMean(x))",
    "ExchangeNeut(x) = CsGroupNeutralize(x, exchange, universe)",
    "Vwap(w) = Divide(TsSum(TRADE_PQ, w), ZeroToNan(TsSum(Divide(TRADE_QTY, adj_factor), w)))",
    "BuyVwap(w) = Divide(TsSum(TRADE_BUY_PQ_INFERRED, w), TsSum(Divide(TRADE_BUY_QTY_INFERRED, adj_factor), w))",
    "SellVwap(w) = Divide(TsSum(TRADE_SELL_PQ_INFERRED, w), TsSum(Divide(TRADE_SELL_QTY_INFERRED, adj_factor), w))",
    "Return(x, y) = Subtract(Divide(y, x), 1)",
    "MidPriceReturn(w) = NanToZero(Return(Delay(CLOSE_PRICE, w), CLOSE_PRICE))",
    "MidPriceReturnDay(w) = If(Le(Subtract(IntervalIndex(), MARKET_START_INDEX), w), NanToZero(Return(DAY_OPEN_PRICE, CLOSE_PRICE)), NanToZero(Return(Delay(CLOSE_PRICE, w), CLOSE_PRICE)))",
    "TradePriceReturn(w) = NanToZero(Return(Delay(Multiply(TRADE_CLOSE, adj_factor), w), Multiply(TRADE_CLOSE, adj_factor)))",
    "TradePriceReturnDay(w) = If(Le(Subtract(IntervalIndex(), MARKET_START_INDEX), w), NanToZero(Return(DAY_OPEN_PRICE, Multiply(TRADE_CLOSE, adj_factor))), TradePriceReturn(w))",
    "High2MidReturn(w) = NanToZero(Return(TsMax(Multiply(TRADE_HIGH, adj_factor), w), CLOSE_PRICE))",
    "Low2MidReturn(w) = NanToZero(Return(TsMin(Multiply(TRADE_LOW, adj_factor), w), CLOSE_PRICE))",
    "Sma2MidReturn(w) = NanToZero(Return(TsMean(CLOSE_PRICE, w), CLOSE_PRICE))",
    "Vwap2MidReturn(w) = NanToZero(Return(Vwap(w), CLOSE_PRICE))",
    "BuyVwap2SellVwapReturn(w) = NanToZero(Return(SellVwap(w), ZeroToNan(BuyVwap(w))))",
    "MomentumRatio(w) = NanToZero(Subtract(Return(TsMin(Multiply(TRADE_LOW, adj_factor), w), CLOSE_PRICE), Return(CLOSE_PRICE, TsMax(Multiply(TRADE_HIGH, adj_factor), w))))",
    "MomentumPower(w1, w2) = NanToZero(Multiply(MidPriceReturn(w1), Divide(TsSum(TRADE_PQ, w1), ZeroToNan(TsSum(TRADE_PQ, w2)))))",
    "RotationRatio(w) = NanToZero(Divide(TsSum(TRADE_PQ, w), Multiply(CLOSE_PRICE, nshares_day)))",
    "NetRotationRatio(w) = NanToZero(Divide(Subtract(TsSum(TRADE_BUY_PQ_INFERRED, w), TsSum(TRADE_SELL_PQ_INFERRED, w)), Multiply(CLOSE_PRICE, nshares_day)))",
    "TradeRatio(w1, w2) = NanToZero(Divide(TsSum(TRADE_PQ, w1), ZeroToNan(TsSum(TRADE_PQ, w2))))",
    "NetTradeRatio(w1, w2) = NanToZero(Divide(Subtract(TsSum(TRADE_BUY_PQ_INFERRED, w1), TsSum(TRADE_SELL_PQ_INFERRED, w1)), ZeroToNan(TsSum(TRADE_PQ, w2))))",
    "TradeBookRatio(w) = NanToZero(Divide(TsSum(TRADE_PQ, w), Add(ZeroToNan(TsMean(ASK_PQ, w)), ZeroToNan(TsMean(BID_PQ, w)))))",
    "NetTradeBookRatio(w) = NanToZero(Divide(Subtract(TsSum(TRADE_BUY_PQ_INFERRED, w), TsSum(TRADE_SELL_PQ_INFERRED, w)), Add(ZeroToNan(ASK_PQ), ZeroToNan(BID_PQ))))",
    "TradePressure(w) = NanToZero(Divide(Subtract(TsSum(TRADE_BUY_PQ_INFERRED, w), TsSum(TRADE_SELL_PQ_INFERRED, w)), Add(ZeroToNan(TsSum(TRADE_BUY_PQ_INFERRED, w)), ZeroToNan(TsSum(TRADE_SELL_PQ_INFERRED, w)))))",
    "BookPressure(w) = NanToZero(Divide(Subtract(TsMean(ASK_PQ, w), TsMean(BID_PQ, w)), Add(ZeroToNan(TsMean(ASK_PQ, w)), ZeroToNan(TsMean(BID_PQ, w)))))",
    "Volatility(w) = NanToZero(Divide(Subtract(TsMax(Multiply(TRADE_HIGH, adj_factor), w), TsMin(Multiply(TRADE_LOW, adj_factor), w)), Add(TsMax(Multiply(TRADE_HIGH, adj_factor), w), TsMin(Multiply(TRADE_LOW, adj_factor), w))))",
    "TsGapMean(x, w1, w2) = Divide(TsGapSum(x, w1, w2), TsGapSum(IsFinite(x), w1, w2))",
    "TsGapStd(x, w1, w2) = Sqrt(Subtract(TsGapMean(Pow(x, 2), w1, w2), Pow(TsGapMean(x, w1, w2), 2)))",
    "TsGapZscore(x, w1, w2) = Divide(Subtract(x, TsGapMean(x, w1, w2)), TsGapStd(x, w1, w2))",

    "ROTATION_RATIO_30M.signal = RotationRatio(30)",

    // features from TAIFEX
    "basis = If(Eq(F_EXIST, 1), Fillforward(Return(MID_PRICE_CLOSE, F_MID_PRICE_CLOSE), interval_1day), Nan())", // fillforward for mid-price basis itself
    "F_CsMean(x) = Divide(CsSum(x, F_EXIST), CsSum(IsFinite(x), F_EXIST))",
    "F_Neut(x) = Subtract(x, F_CsMean(x))",

    "TAIFEX_SSF_exist.signal = F_EXIST",
    "TAIFEX_raw_basis.signal = basis", // futures exists
    "TAIFEX_basis_rel.signal = F_Neut(basis)",
    "TAIFEX_basis_csrank.signal = CsRank(basis, F_EXIST)", // futures exists
    "TAIFEX_basis_tsrank_30.signal = TsRankSimple(basis, 30)", // futures exists
    "TAIFEX_basis_tsrank_1day.signal = TsRankSimple(basis, interval_1day)", // futures exists

    "F_TRADE_PQ_MULT = Multiply(F_TRADE_PQ, F_QTY_MULTIPLIER)",
    "F2_TRADE_PQ_MULT = Multiply(F2_TRADE_PQ, F2_QTY_MULTIPLIER)",
    "F12_TRADE_PQ_MULT = Add(F_TRADE_PQ_MULT, F2_TRADE_PQ_MULT)",

    "FSVolumeRatio(x) = Divide(TsSum(F_TRADE_PQ_MULT, x), TsSum(TRADE_PQ, x))",
    "FS12VolumeRatio(x) = Divide(TsSum(F12_TRADE_PQ_MULT, x), TsSum(TRADE_PQ, x))",

    "TAIFEX_future_spot_volume_ratio_30.signal = FS12VolumeRatio(30)",
    "TAIFEX_future_spot_volume_ratio_1day.signal = FS12VolumeRatio(interval_1day)",

    "TAIFEX_future_csrank_spot_volume_ratio_30.signal = CsRank(TAIFEX_future_spot_volume_ratio_30.signal, F_EXIST)",
    "TAIFEX_future_csrank_spot_volume_ratio_1day.signal = CsRank(TAIFEX_future_spot_volume_ratio_1day.signal, F_EXIST)",

    // SIGNALS
    "SHORT_D0.signal = Eq(day_trading_indicator_taiwan, 1)",
    "NOT_SHORT_D0.signal = Negation(SHORT_D0.signal)",
    "SHORT_D1.signal = Delay(SHORT_D0.signal, interval_1day)",
    "NOT_SHORT_D1.signal = Negation(SHORT_D1.signal)",
    "anomaly_stock.signal = Ge(stock_anomaly_code, 1)",

    // SAMPLERS ////////////////////////////////////////////////////////////
    "valid_time_window(s, e) = And(And(VALID, Lt(hhmmss, e)), Ge(hhmmss, s))",
    "time_0901_1322_sampler = valid_time_window(90100, 132200)",
    "time_1230_1322_sampler = valid_time_window(123000, 132200)",
    "time_1322_1325_sampler = valid_time_window(132200, 132500)",

    "all_model_sampler = valid_time_window(90100, 132500)",
    "morning_sampler = valid_time_window(90100, 100000)",
    "afternoon_sampler = valid_time_window(100000, 132500)",

    "turnover_rank_5min_top200 = Le(CsRawRank(TsSum(TRADE_PQ, 5), TOP900), 200)",
    "all_model_sampler_du = And(turnover_rank_5min_top200, all_model_sampler)",
    "morning_sampler_du = And(turnover_rank_5min_top200, morning_sampler)",
    "afternoon_sampler_du = And(turnover_rank_5min_top200, afternoon_sampler)",

    "universe_top_50_100 = And(TOP100, Negation(TOP50))",
    "universe_top_1200_2000 = And(TOP2000, Negation(TOP1200))",

    // new setup
    "universe_top_50_and_low_liq = Or(TOP50, universe_top_1200_2000)",
    "UNIVERSE_OUT_VALID = Negation(universe_top_50_and_low_liq)",
    "universe_out_model_sampler = And(And(UNIVERSE_OUT_VALID, Lt(hhmmss, 132500)), Ge(hhmmss, 90100))",

    "low_liq_morning_sampler = And(morning_sampler, universe_top_1200_2000)",
    "top_50_and_low_liq_morning_sampler = And(morning_sampler, universe_top_50_and_low_liq)",
    "top_50_and_low_liq_afternoon_sampler = And(afternoon_sampler, universe_top_50_and_low_liq)",
    "top_50_morning_sampler = And(morning_sampler, TOP50)",
    "top_50_afternoon_sampler = And(afternoon_sampler, TOP50)",
    ///////////////////////////////////////////////////////////////////////
  ],
  "interval_1day": 265,
  "io_spec": {
    "dump_data_names": [],
    "dump_data_root": "",
    "read_data_names": [
      "TOP50",
      "TOP100",
      "TOP200",
      "TOP300",
      "TOP400",
      "TOP600",
      "TOP900",
      "TOP1200",
      "TOP2000",
      "MOVE_BPS_SUM",
      "TRADE_CLOSE",
      "TRADE_QTY",
      "TRADE_PQ",
      "TRADE_BUY_PQ_INFERRED",
      "TRADE_BUY_COUNT_INFERRED",
      "TRADE_SELL_PQ_INFERRED",
      "TRADE_SELL_COUNT_INFERRED",
      "TRADE_BUY_QTY_INFERRED",
      "TRADE_SELL_QTY_INFERRED",
      "adj_factor",
      "nshares_day",
      "prev_adj_factor",
      "prev_open_day",
      "prev_high_day",
      "prev_low_day",
      "prev_close_day",
      "prev_5days_max_volatility",
      "prev_5days_max_atr",
      "prev_rotation_rank_top2000",
      "turnover_ma5",
      "prev_5days_ret_rank_top2000",
      "prev_5days_intra_volatility",
      "prev2_close_2_prev_close",
      "prev_open_2_prev_close",
      "SPREAD_CLOSE",
      "prev_5days_ovn_volatility",
      "prev_turnover_rank_top2000",
      "log_prev_rotation",
//      "prev_5days_interval_length",
      "twse",
      "tpex",
      "day_trading_indicator_taiwan",
      "HHMM_TAIWAN",
      "hhmmss",
      "ASK_0_PRICE",
      "ASK_0_QTY",
      "BID_0_PRICE",
      "BID_0_QTY",
      "TRADE_COUNT",
      "BOOK_VALID_COUNT",
      "MID_PRICE_CLOSE",
      "TRADE_HIGH",
      "TRADE_LOW",
      "TRADE_OPEN",
      "stock_anomaly_code",

      // data from futures
      "F_EXIST",
      "F_QTY_MULTIPLIER",
      "F_ASK_0_PRICE",
      "F_ASK_0_QTY",
      "F_BID_0_PRICE",
      "F_BID_0_QTY",
      "F_BOOK_COUNT",
      "F_BOOK_VALID_COUNT",
      "F_MID_PRICE_CLOSE",
      "F_MID_PRICE_SUM",
      "F_MOVE_BPS_SUM",
      "F_SPREAD_CLOSE",
      "F_SPREAD_SUM",
      "F_STABLE_MID_PRICE_CLOSE",
      "F_TRADE_BUY_COUNT",
      "F_TRADE_BUY_COUNT_INFERRED",
      "F_TRADE_BUY_PQ",
      "F_TRADE_BUY_PQ_INFERRED",
      "F_TRADE_BUY_QTY",
      "F_TRADE_BUY_QTY_INFERRED",
      "F_TRADE_CLOSE",
      "F_TRADE_COUNT",
      "F_TRADE_HIGH",
      "F_TRADE_LOW",
      "F_TRADE_OPEN",
      "F_TRADE_PQ",
      "F_TRADE_QTY",
      "F_TRADE_SELL_COUNT",
      "F_TRADE_SELL_COUNT_INFERRED",
      "F_TRADE_SELL_PQ",
      "F_TRADE_SELL_PQ_INFERRED",
      "F_TRADE_SELL_QTY",
      "F_TRADE_SELL_QTY_INFERRED",
      "F2_EXIST",
      "F2_QTY_MULTIPLIER",
      "F2_ASK_0_PRICE",
      "F2_ASK_0_QTY",
      "F2_BID_0_PRICE",
      "F2_BID_0_QTY",
      "F2_BOOK_COUNT",
      "F2_BOOK_VALID_COUNT",
      "F2_MID_PRICE_CLOSE",
      "F2_MID_PRICE_SUM",
      "F2_MOVE_BPS_SUM",
      "F2_SPREAD_CLOSE",
      "F2_SPREAD_SUM",
      "F2_STABLE_MID_PRICE_CLOSE",
      "F2_TRADE_BUY_COUNT",
      "F2_TRADE_BUY_COUNT_INFERRED",
      "F2_TRADE_BUY_PQ",
      "F2_TRADE_BUY_PQ_INFERRED",
      "F2_TRADE_BUY_QTY",
      "F2_TRADE_BUY_QTY_INFERRED",
      "F2_TRADE_CLOSE",
      "F2_TRADE_COUNT",
      "F2_TRADE_HIGH",
      "F2_TRADE_LOW",
      "F2_TRADE_OPEN",
      "F2_TRADE_PQ",
      "F2_TRADE_QTY",
      "F2_TRADE_SELL_COUNT",
      "F2_TRADE_SELL_COUNT_INFERRED",
      "F2_TRADE_SELL_PQ",
      "F2_TRADE_SELL_PQ_INFERRED",
      "F2_TRADE_SELL_QTY",
      "F2_TRADE_SELL_QTY_INFERRED"
    ]
  },
  "n_prev_days": 5,
  "nan_check_skipping_basic_data": [
    "F_TRADE_CLOSE",
    "F_TRADE_HIGH",
    "F_TRADE_LOW",
    "F_TRADE_OPEN",
    "F2_TRADE_CLOSE",
    "F2_TRADE_HIGH",
    "F2_TRADE_LOW",
    "F2_TRADE_OPEN"
  ]
}
